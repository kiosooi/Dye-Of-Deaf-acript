local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")
local Stats = game:GetService("Stats")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SetupRemote = ReplicatedStorage:WaitForChild("Setup")

local LocalPlayer = Players.LocalPlayer

-- WINDOW
local Window = Rayfield:CreateWindow({
    Name = "Dye of Deaf Script",
    LoadingTitle = "Dye of Deaf",
    LoadingSubtitle = "by Kosoi",
    Theme = "Ocean",
    ToggleUIKeybind = "K",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "KosoiHub",
        FileName = "DyeOfDeaf"
    }
})

-- MAIN TAB
local Tab = Window:CreateTab("Main", 0)
Tab:CreateSection("Stamina")

-- ===== STAMINA HELPERS =====
local staminaValue = math.huge
local autoStamina = false
local staminaConn

local function getStats()
    if workspace.Teams:FindFirstChild("Civilians") and workspace.Teams.Civilians:FindFirstChild(LocalPlayer.Name) then
        return workspace.Teams.Civilians[LocalPlayer.Name]:FindFirstChild("Stats")
    end
    if workspace.Teams:FindFirstChild("Killers") and workspace.Teams.Killers:FindFirstChild(LocalPlayer.Name) then
        return workspace.Teams.Killers[LocalPlayer.Name]:FindFirstChild("Stats")
    end
    return nil
end

---------------------------------------------------------------------
-- STAMINA INPUT (SAVED + LOADED)
---------------------------------------------------------------------
Tab:CreateInput({
    Name = "Stamina Value",
    PlaceholderText = "Example: 400 / 9999",
    RemoveTextAfterFocusLost = false,
    Flag = "stamina_value",
    Callback = function(Text)
        local num = tonumber(Text)
        if num then
            staminaValue = num
        end
    end
})

-- LOAD SAVED STAMINA VALUE ON EXECUTE / SERVER HOP
task.defer(function()
    local saved = Rayfield.Flags["stamina_value"]
    if saved and tonumber(saved) then
        staminaValue = tonumber(saved)
    end
end)

-- AUTO STAMINA TOGGLE
Tab:CreateToggle({
    Name = "Auto Change Stamina",
    CurrentValue = false,
    Flag = "auto_stamina",
    Callback = function(Value)
        autoStamina = Value
        if autoStamina then
            staminaConn = RunService.Heartbeat:Connect(function()
                local stats = getStats()
                if stats then
                    if stats:FindFirstChild("MaxStamina") then stats.MaxStamina.Value = staminaValue end
                    if stats:FindFirstChild("Stamina") then stats.Stamina.Value = staminaValue end
                end
            end)
        else
            if staminaConn then staminaConn:Disconnect() staminaConn = nil end
        end
    end
})

-- ===== ESP (AUTO TEAM CHECK, AUTO UPDATE) =====
Tab:CreateSection("ESP")

local espEnabled = false
local espCache = {}

local function removeESP(plr)
    if espCache[plr] then
        espCache[plr]:Destroy()
        espCache[plr] = nil
    end
end

local function getPlayerTeam(plr)
    if workspace.Teams:FindFirstChild("Killers") and workspace.Teams.Killers:FindFirstChild(plr.Name) then
        return "Killer"
    end
    if workspace.Teams:FindFirstChild("Civilians") and workspace.Teams.Civilians:FindFirstChild(plr.Name) then
        return "Civilian"
    end
    return nil
end

local function applyESPToPlayer(plr)
    if not espEnabled then return end
    if plr == LocalPlayer then return end
    if not plr.Character then return end

    removeESP(plr)

    local team = getPlayerTeam(plr)
    if not team then return end

    local hl = Instance.new("Highlight")
    hl.Adornee = plr.Character
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.FillTransparency = 0.35
    hl.OutlineTransparency = 0

    if team == "Killer" then
        hl.FillColor = Color3.fromRGB(255, 60, 60)
        hl.OutlineColor = Color3.fromRGB(255, 0, 0)
    else
        hl.FillColor = Color3.fromRGB(60, 255, 60)
        hl.OutlineColor = Color3.fromRGB(0, 255, 0)
    end

    hl.Parent = game.CoreGui
    espCache[plr] = hl
end

local function refreshESP()
    for _, plr in ipairs(Players:GetPlayers()) do
        applyESPToPlayer(plr)
    end
end

local function clearESP()
    for plr, hl in pairs(espCache) do
        if hl then hl:Destroy() end
        espCache[plr] = nil
    end
end

-- PLAYER CONNECTIONS
Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function()
        task.wait(0.5)
        applyESPToPlayer(plr)
    end)
end)

Players.PlayerRemoving:Connect(removeESP)

-- AUTO REFRESH (TEAM / INVIS / MODEL CHANGES)
task.spawn(function()
    while true do
        if espEnabled then
            refreshESP()
        end
        task.wait(1)
    end
end)

-- ESP TOGGLE
Tab:CreateToggle({
    Name = "ESP",
    CurrentValue = false,
    Flag = "esp",
    Callback = function(Value)
        espEnabled = Value
        if Value then
            refreshESP()
        else
            clearESP()
        end
    end
})

-- ===== NAME + HP ESP (ROUND-PERSISTENT) =====

local nameESPEnabled = false
local hpESPEnabled = false

local textEspCache = {}

-- Team + Health lookup
local function getTeamAndHealth(plr)
    local teams = workspace:FindFirstChild("Teams")
    if not teams then return nil, nil end

    local killers = teams:FindFirstChild("Killers")
    local civilians = teams:FindFirstChild("Civilians")

    local folder
    local teamType

    if killers and killers:FindFirstChild(plr.Name) then
        folder = killers[plr.Name]
        teamType = "Killer"
    elseif civilians and civilians:FindFirstChild(plr.Name) then
        folder = civilians[plr.Name]
        teamType = "Civilian"
    end

    if not folder then return nil, nil end

    local stats = folder:FindFirstChild("Stats")
    local healthValue = stats and stats:FindFirstChild("Health")

    return teamType, healthValue and healthValue.Value or nil
end

-- Build the display text
local function buildText(plr)
    local _, hp = getTeamAndHealth(plr)
    local hpText = hp and ("HP: " .. math.floor(hp)) or "HP: ?"

    if nameESPEnabled and hpESPEnabled then
        return hpText .. " | " .. plr.Name
    elseif hpESPEnabled then
        return hpText
    elseif nameESPEnabled then
        return plr.Name
    end

    return ""
end

-- Remove ESP
local function removeTextESP(plr)
    if textEspCache[plr] then
        textEspCache[plr]:Destroy()
        textEspCache[plr] = nil
    end
end

-- Create or refresh ESP for a player
local function createTextESP(plr)
    if not (nameESPEnabled or hpESPEnabled) then return end
    if plr == LocalPlayer then return end
    if not plr.Character then return end

    local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local teamType = select(1, getTeamAndHealth(plr))
    if not teamType then return end

    removeTextESP(plr)

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "NameHpESP"
    billboard.Adornee = hrp
    billboard.Size = UDim2.new(0, 220, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextStrokeTransparency = 0
    label.TextScaled = true
    label.Font = Enum.Font.SourceSansBold

    label.TextColor3 = teamType == "Killer"
        and Color3.fromRGB(255, 60, 60)
        or Color3.fromRGB(60, 255, 60)

    label.Text = buildText(plr)
    label.Parent = billboard

    billboard.Parent = game.CoreGui
    textEspCache[plr] = billboard
end

-- Refresh ESP for all players
local function refreshTextESP()
    for _, plr in ipairs(Players:GetPlayers()) do
        createTextESP(plr)
    end
end

-- Character respawn handling
local function hookPlayer(plr)
    plr.CharacterAdded:Connect(function()
        task.wait(0.5)
        createTextESP(plr)
    end)
end

for _, plr in ipairs(Players:GetPlayers()) do
    hookPlayer(plr)
end

Players.PlayerAdded:Connect(hookPlayer)
Players.PlayerRemoving:Connect(removeTextESP)

-- Live HP / name update
RunService.Heartbeat:Connect(function()
    for plr, gui in pairs(textEspCache) do
        local label = gui:FindFirstChildOfClass("TextLabel")
        if label then
            label.Text = buildText(plr)
        end
    end
end)

-- Safety refresh loop
task.spawn(function()
    while true do
        if nameESPEnabled or hpESPEnabled then
            refreshTextESP()
        end
        task.wait(1)
    end
end)

-- ===== TOGGLES =====
Tab:CreateToggle({
    Name = "Name ESP",
    CurrentValue = false,
    Flag = "name_esp",
    Callback = function(Value)
        nameESPEnabled = Value
        refreshTextESP()
    end
})

Tab:CreateToggle({
    Name = "HP ESP",
    CurrentValue = false,
    Flag = "hp_esp",
    Callback = function(Value)
        hpESPEnabled = Value
        refreshTextESP()
    end
})

-- ===== PROXIMITY PROMPTS =====

Tab:CreateSection("anti proximity prompts | ts is the reason the auto save works idk why ðŸ¥€ðŸ˜”")

local promptConn

Tab:CreateToggle({
    Name = "Anti proximity prompt hold duration",
    CurrentValue = false,
    Flag = "proximity",
    Callback = function(Value)
        if Value then
            for _, p in pairs(workspace:GetDescendants()) do
                if p:IsA("ProximityPrompt") then p.HoldDuration = 0 end
            end
            promptConn = workspace.DescendantAdded:Connect(function(d)
                if d:IsA("ProximityPrompt") then d.HoldDuration = 0 end
            end)
        else
            if promptConn then promptConn:Disconnect() promptConn = nil end
        end
    end
})

-- ===== Self Fling (VERY FUNNY) =====

local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Humanoid.RootPart

LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    Humanoid = char:WaitForChild("Humanoid")
    RootPart = Humanoid.RootPart
end)

local Config = {
    Enabled = false,

    FlingHotkey = "X",
    TpBackHotkey = "C",

    Power = 250,
    Upward = 120,
    Spin = 600,
    BurstTime = 0.15
}

local CurrentPos
local Flinging = false
local InputConnection
local InputEndedConnection

-- Section
Tab:CreateSection("Self Fling (VERY FUNNY)")

-- Keybind textboxes (ABOVE toggle)
Tab:CreateInput({
    Name = "Fling keybind",
    PlaceholderText = "X",
    CurrentValue = "X",
    Callback = function(Value)
        if Value ~= "" then
            Config.FlingHotkey = Value:upper()
        end
    end
})

Tab:CreateInput({
    Name = "TpBack Keybind",
    PlaceholderText = "C",
    CurrentValue = "C",
    Callback = function(Value)
        if Value ~= "" then
            Config.TpBackHotkey = Value:upper()
        end
    end
})

local Charge = 1
local MaxCharge = 5
local ChargeSpeed = 3

-- Charge
Tab:CreateInput({
    Name = "Charge",
    PlaceholderText = "1",
    CurrentValue = "1",
    Callback = function(Value)
        local num = tonumber(Value)
        if num then Charge = num end
    end
})

-- MaxCharge
Tab:CreateInput({
    Name = "MaxCharge",
    PlaceholderText = "5",
    CurrentValue = "5",
    Callback = function(Value)
        local num = tonumber(Value)
        if num then MaxCharge = num end
    end
})

-- ChargeSpeed
Tab:CreateInput({
    Name = "ChargeSpeed",
    PlaceholderText = "3",
    CurrentValue = "3",
    Callback = function(Value)
        local num = tonumber(Value)
        if num then ChargeSpeed = num end
    end
})

-- Toggle
Tab:CreateToggle({
    Name = "Self Fling",
    CurrentValue = false,
    Flag = "self_fling_toggle",
    Callback = function(Value)
        Config.Enabled = Value

        if Value then
            local Charging = false

            InputConnection = UserInputService.InputBegan:Connect(function(input, typing)
                if typing or not Config.Enabled or not RootPart then return end

                -- HOLD TO STACK
                if input.KeyCode == Enum.KeyCode[Config.FlingHotkey] and not Charging then
                    Charging = true

                    if RootPart.Velocity.Magnitude < 20 then
                        CurrentPos = RootPart.CFrame
                    end

                    task.spawn(function()
                        while Charging and Config.Enabled and RootPart do
                            Charge = math.clamp(
                                Charge + RunService.Heartbeat:Wait() * ChargeSpeed,
                                1,
                                MaxCharge
                            )

                            RootPart.Velocity =
                                RootPart.CFrame.LookVector * (Config.Power * Charge)
                                + Vector3.new(0, Config.Upward * Charge, 0)

                            RootPart.RotVelocity = Vector3.new(
                                math.random(-Config.Spin, Config.Spin),
                                math.random(-Config.Spin, Config.Spin),
                                math.random(-Config.Spin, Config.Spin)
                            ) * Charge
                        end
                    end)

                -- TP BACK
                elseif input.KeyCode == Enum.KeyCode[Config.TpBackHotkey] then
                    if CurrentPos then
                        RootPart.Velocity = Vector3.zero
                        RootPart.RotVelocity = Vector3.zero
                        RootPart.CFrame = CurrentPos
                        Humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
                    end
                end
            end)

            InputEndedConnection = UserInputService.InputEnded:Connect(function(input)
                if input.KeyCode == Enum.KeyCode[Config.FlingHotkey] then
                    Charging = false
                end
            end)

        else
            if InputConnection then
                InputConnection:Disconnect()
                InputConnection = nil
            end

            if InputEndedConnection then
                InputEndedConnection:Disconnect()
                InputEndedConnection = nil
            end
        end
    end
})

-- Power
Tab:CreateInput({
    Name = "Power",
    PlaceholderText = tostring(Config.Power),
    CurrentValue = tostring(Config.Power),
    Callback = function(Value)
        local num = tonumber(Value)
        if num then Config.Power = num end
    end
})

-- Upward
Tab:CreateInput({
    Name = "Upward",
    PlaceholderText = tostring(Config.Upward),
    CurrentValue = tostring(Config.Upward),
    Callback = function(Value)
        local num = tonumber(Value)
        if num then Config.Upward = num end
    end
})

-- Spin
Tab:CreateInput({
    Name = "Spin",
    PlaceholderText = tostring(Config.Spin),
    CurrentValue = tostring(Config.Spin),
    Callback = function(Value)
        local num = tonumber(Value)
        if num then Config.Spin = num end
    end
})

-- BurstTime
Tab:CreateInput({
    Name = "BurstTime",
    PlaceholderText = tostring(Config.BurstTime),
    CurrentValue = tostring(Config.BurstTime),
    Callback = function(Value)
        local num = tonumber(Value)
        if num then Config.BurstTime = num end
    end
})

---------------------------------------------------------------------
-- ===== ABILITIES TAB =====
---------------------------------------------------------------------

local AbilitiesTab = Window:CreateTab("Abilities", 0)
AbilitiesTab:CreateSection("Card Abilities")

-- Ability module data
local CardAbilities = {
    { Name = "Punch", Icon = "rbxassetid://73130054435684" },
    { Name = "Caretaker", Icon = "rbxassetid://79847866387639" },
    { Name = "Revolver", Icon = "rbxassetid://121722959097329" },
    { Name = "Hotdog", Icon = "rbxassetid://81176509322805" },
    { Name = "Bonus Pad", Icon = "rbxassetid://109145887371111" },
    { Name = "Taunt", Icon = "rbxassetid://122433943011026" },
    { Name = "Cloak", Icon = "rbxassetid://124123778974648" },
    { Name = "Dash", Icon = "rbxassetid://117074852938163" },
    { Name = "Adrenaline", Icon = "rbxassetid://130391534451239" },
    { Name = "Block", Icon = "rbxassetid://114764935401015" },
    { Name = "Banana Peel", Icon = "rbxassetid://77890674914190" },
}

-- Build dropdown name list
local AbilityNames = {}
for _, ability in ipairs(CardAbilities) do
    table.insert(AbilityNames, ability.Name)
end

local selectedAbility1 = AbilityNames[1]
local selectedAbility2 = AbilityNames[2]

---------------------------------------------------------------------
-- Dropdown 1 (FIXED)
---------------------------------------------------------------------
AbilitiesTab:CreateDropdown({
    Name = "Card ability 1",
    Options = AbilityNames,
    CurrentOption = { selectedAbility1 },
    Callback = function(Value)
        selectedAbility1 = Value[1]
    end
})

---------------------------------------------------------------------
-- Dropdown 2 (FIXED)
---------------------------------------------------------------------
AbilitiesTab:CreateDropdown({
    Name = "Card ability 2",
    Options = AbilityNames,
    CurrentOption = { selectedAbility2 },
    Callback = function(Value)
        selectedAbility2 = Value[1]
    end
})

---------------------------------------------------------------------
-- Helper to get ability data
---------------------------------------------------------------------
local function getAbilityData(name)
    for _, ability in ipairs(CardAbilities) do
        if ability.Name == name then
            return ability
        end
    end
end

---------------------------------------------------------------------
-- Button: Get Card Abilities (FIXED)
---------------------------------------------------------------------
AbilitiesTab:CreateButton({
    Name = "Get Card abilities",
    Callback = function()
        local a1 = getAbilityData(selectedAbility1)
        local a2 = getAbilityData(selectedAbility2)

        if not a1 or not a2 then
            warn("Invalid ability selection")
            return
        end

        game:GetService("ReplicatedStorage")
            :WaitForChild("Setup")
            :FireServer(
                { Name = a1.Name, Icon = a1.Icon },
                { Name = a2.Name, Icon = a2.Icon }
            )
    end
})

---------------------------------------------------------------------
-- Auto delete Card Pick GUI
---------------------------------------------------------------------
local autoDeleteCardPick = false

AbilitiesTab:CreateToggle({
    Name = "Auto delete Pick Card ScreenGui",
    CurrentValue = false,
    Flag = "auto_delete_cardpick",
    Callback = function(Value)
        autoDeleteCardPick = Value

        if Value then
            task.spawn(function()
                while autoDeleteCardPick do
                    local gui = LocalPlayer:FindFirstChild("PlayerGui")
                    if gui then
                        local cardPick = gui:FindFirstChild("CardPick")
                        if cardPick then
                            cardPick:Destroy()
                        end
                    end
                    task.wait(0.11)
                end
            end)
        end
    end
})

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SetupRemote = ReplicatedStorage:WaitForChild("Setup")

local SynergySection = AbilitiesTab:CreateSection("Synergies")

-- DashTech (Taunt + Dash)
AbilitiesTab:CreateButton({
    Name = "DashTech (Taunt + Dash)",
    Callback = function()
        SetupRemote:FireServer(
            {Name = "Taunt", Icon = "rbxassetid://122433943011026"},
            {Name = "Dash", Icon = "rbxassetid://117074852938163"}
        )
    end
})

-- CloakTech (Taunt + Cloak)
AbilitiesTab:CreateButton({
    Name = "OneHit Wonder (Taunt + Cloak)",
    Callback = function()
        SetupRemote:FireServer(
            {Name = "Taunt", Icon = "rbxassetid://122433943011026"},
            {Name = "Cloak", Icon = "rbxassetid://124123778974648"}
        )
    end
})

-- Carepad (Caretaker + Bonus Pad)
AbilitiesTab:CreateButton({
    Name = "Carepad (Caretaker + Bonus Pad)",
    Callback = function()
        SetupRemote:FireServer(
            {Name = "Caretaker", Icon = "rbxassetid://79847866387639"},
            {Name = "Bonus Pad", Icon = "rbxassetid://109145887371111"}
        )
    end
})

-- DamagePad (Bonus Pad + Punch)
AbilitiesTab:CreateButton({
    Name = "DamagePad (Bonus Pad + Punch)",
    Callback = function()
        SetupRemote:FireServer(
            {Name = "Bonus Pad", Icon = "rbxassetid://109145887371111"},
            {Name = "Punch", Icon = "rbxassetid://73130054435684"}
        )
    end
})

-- LoveShot (Revolver + Caretaker)
AbilitiesTab:CreateButton({
    Name = "LoveShot (Revolver + Caretaker)",
    Callback = function()
        SetupRemote:FireServer(
            {Name = "Revolver", Icon = "rbxassetid://121722959097329"},
            {Name = "Caretaker", Icon = "rbxassetid://79847866387639"}
        )
    end
})

-- Black Punch (Punch + Block)
AbilitiesTab:CreateButton({
    Name = "Black Punch (Punch + Block)",
    Callback = function()
        SetupRemote:FireServer(
            {Name = "Punch", Icon = "rbxassetid://73130054435684"},
            {Name = "Block", Icon = "rbxassetid://114764935401015"}
        )
    end
})

AbilitiesTab:CreateSection("auto use Abilities if you are lazy to do it yourself")

-- Toggle states
local SpamAbility1 = false
local SpamAbility2 = false

-- Toggle: Ability 1
AbilitiesTab:CreateToggle({
    Name = "Auto Use Ability 1",
    CurrentValue = false,
    Callback = function(Value)
        SpamAbility1 = Value
    end
})

-- Toggle: Ability 2
AbilitiesTab:CreateToggle({
    Name = "Auto Use Ability 2",
    CurrentValue = false,
    Callback = function(Value)
        SpamAbility2 = Value
    end
})

-- Helper: read ability name from GUI
local function getAbilityName(abilitiesFolder, abilityFolderName)
    local abilityFolder = abilitiesFolder:FindFirstChild(abilityFolderName)
    if not abilityFolder then return nil end

    local label = abilityFolder:FindFirstChild("AbilityName")
    if label and label:IsA("TextLabel") then
        return label.Text
    end

    return nil
end

-- Loop: Ability 1
task.spawn(function()
    while true do
        if SpamAbility1 then
            pcall(function()
                local player = game:GetService("Players").LocalPlayer
                local abilities = player.PlayerGui:WaitForChild("Abilities")
                local remote = abilities:WaitForChild("KeyStuff"):WaitForChild("HandleAllat")

                local name = getAbilityName(abilities, "Ability1")
                if name then
                    remote:FireServer(name, abilities:WaitForChild("Ability1"))
                end
            end)
        end
        task.wait(0)
    end
end)

-- Loop: Ability 2
task.spawn(function()
    while true do
        if SpamAbility2 then
            pcall(function()
                local player = game:GetService("Players").LocalPlayer
                local abilities = player.PlayerGui:WaitForChild("Abilities")
                local remote = abilities:WaitForChild("KeyStuff"):WaitForChild("HandleAllat")

                local name = getAbilityName(abilities, "Ability2")
                if name then
                    remote:FireServer(name, abilities:WaitForChild("Ability2"))
                end
            end)
        end
        task.wait(0)
    end
end)

---------------------------------------------------------------------
-- Ability Changer
---------------------------------------------------------------------

AbilitiesTab:CreateSection("Ability changer")

-- Build dropdown list (+ None)
local AbilityOptions = { "None" }
for _, ability in ipairs(CardAbilities) do
    table.insert(AbilityOptions, ability.Name)
end

local SelectedAbility1 = "None"
local SelectedAbility2 = "None"

-- Dropdown: Ability 1
AbilitiesTab:CreateDropdown({
    Name = "Change Ability1",
    Options = AbilityOptions,
    CurrentOption = { "None" },
    Callback = function(Value)
        SelectedAbility1 = Value[1]
    end
})

-- Dropdown: Ability 2
AbilitiesTab:CreateDropdown({
    Name = "Change Ability2",
    Options = AbilityOptions,
    CurrentOption = { "None" },
    Callback = function(Value)
        SelectedAbility2 = Value[1]
    end
})

-- Helper: get ability data
local function getAbilityData(name)
    for _, ability in ipairs(CardAbilities) do
        if ability.Name == name then
            return ability
        end
    end
end

-- Helper: apply ability to GUI slot
local function applyAbility(slotName, abilityData)
    local abilitiesGui = LocalPlayer.PlayerGui:WaitForChild("Abilities")
    local slot = abilitiesGui:WaitForChild(slotName)

    local nameLabel = slot:FindFirstChild("AbilityName")
    if nameLabel then
        nameLabel.Text = abilityData.Name
    end

    local icon = slot:FindFirstChild("Icon")
    if icon then
        icon.Image = abilityData.Icon
    end
end

-- Button: Apply Ability Change
AbilitiesTab:CreateButton({
    Name = "Change Ability",
    Callback = function()
        local args = {}

        -- Ability 1
        if SelectedAbility1 ~= "None" then
            local data1 = getAbilityData(SelectedAbility1)
            if data1 then
                applyAbility("Ability1", data1)
                table.insert(args, {
                    Name = data1.Name,
                    Icon = data1.Icon
                })
            end
        end

        -- Ability 2
        if SelectedAbility2 ~= "None" then
            local data2 = getAbilityData(SelectedAbility2)
            if data2 then
                applyAbility("Ability2", data2)
                table.insert(args, {
                    Name = data2.Name,
                    Icon = data2.Icon
                })
            end
        end

        -- Fire Setup remote (must always receive 2 entries)
        if #args > 0 then
            if #args == 1 then
                table.insert(args, args[1])
            end

            SetupRemote:FireServer(unpack(args))
        end
    end
})

---------------------------------------------------------------------
-- ===== Ability Changer (Extra Slot) =====
---------------------------------------------------------------------

AbilitiesTab:CreateSection("Ability Changer")

-- Build dropdown list (NO None)
local AbilityOptions = {}
for _, ability in ipairs(CardAbilities) do
    table.insert(AbilityOptions, ability.Name)
end

local SelectedExtraAbility = AbilityOptions[1]
local ExtraAbilityKey = "G"
local ExtraAbilityEnabled = false
local ExtraAbilityButton = nil

---------------------------------------------------------------------
-- Dropdown
---------------------------------------------------------------------
AbilitiesTab:CreateDropdown({
    Name = "Extra Ability",
    Options = AbilityOptions,
    CurrentOption = { AbilityOptions[1] },
    Callback = function(Value)
        SelectedExtraAbility = Value[1]
    end
})

---------------------------------------------------------------------
-- Keybind textbox
---------------------------------------------------------------------
AbilitiesTab:CreateInput({
    Name = "Ability Keybind",
    PlaceholderText = "G",
    CurrentValue = "G",
    Callback = function(Value)
        if Value ~= "" then
            ExtraAbilityKey = Value:upper()
            if ExtraAbilityButton then
                ExtraAbilityButton.Key.Text = ExtraAbilityKey
            end
        end
    end
})

---------------------------------------------------------------------
-- Helper: find ability data
---------------------------------------------------------------------
local function getAbilityDataByName(name)
    for _, ability in ipairs(CardAbilities) do
        if ability.Name == name then
            return ability
        end
    end
end

---------------------------------------------------------------------
-- Cooldown GUI
---------------------------------------------------------------------
local ExtraCooldownGui = nil
local ShowExtraCooldowns = false
local function createExtraCooldownGui()
    if ExtraCooldownGui then ExtraCooldownGui:Destroy() end

    ExtraCooldownGui = Instance.new("ScreenGui")
    ExtraCooldownGui.Name = "ExtraAbilityCooldowns"
    ExtraCooldownGui.ResetOnSpawn = false
    ExtraCooldownGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 200, 0, 50)
    frame.Position = UDim2.new(0, 5, 1, -55)
    frame.BackgroundTransparency = 0.3
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.Parent = ExtraCooldownGui
end

local function updateExtraCooldownGui()
    if not ExtraCooldownGui then return end
    ExtraCooldownGui:ClearAllChildren()
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 200, 0, 50)
    frame.Position = UDim2.new(0, 5, 1, -55)
    frame.BackgroundTransparency = 0.3
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.Parent = ExtraCooldownGui

    if ExtraAbilityEnabled and ExtraAbilityButton then
        local lbl = Instance.new("TextLabel")
        lbl.Size = UDim2.new(1, -10, 0, 20)
        lbl.Position = UDim2.new(0, 5, 0, 5)
        lbl.TextColor3 = Color3.fromRGB(255, 255, 255)
        lbl.Text = ExtraAbilityButton.AbilityName.Text..": "..tostring(AbilityCooldowns[ExtraAbilityButton.AbilityName.Text] or "?").."s"
        lbl.BackgroundTransparency = 1
        lbl.TextXAlignment = Enum.TextXAlignment.Left
        lbl.Parent = frame
    end
end

---------------------------------------------------------------------
-- Toggle
---------------------------------------------------------------------
AbilitiesTab:CreateToggle({
    Name = "Enable Extra Ability",
    CurrentValue = false,
    Callback = function(Value)
        ExtraAbilityEnabled = Value

        local player = LocalPlayer
        local gui = player:WaitForChild("PlayerGui")
        local abilitiesGui = gui:WaitForChild("Abilities")

        -- CLEANUP
        if not Value then
            if ExtraAbilityButton then
                ExtraAbilityButton:Destroy()
                ExtraAbilityButton = nil
            end
            updateExtraCooldownGui()
            -- reset original positions
            for _, name in ipairs({ "Ability1", "Ability2" }) do
                local ab = abilitiesGui:FindFirstChild(name)
                if ab then
                    ab.Position = ab.Position + UDim2.fromOffset(90, 0)
                end
            end
            return
        end

        local data = getAbilityDataByName(SelectedExtraAbility)
        if not data then return end

        local ability2 = abilitiesGui:FindFirstChild("Ability2")
        if not ability2 then return end

        -- FIND NEXT SLOT NUMBER
        local index = 3
        while abilitiesGui:FindFirstChild("Ability" .. index) do
            index += 1
        end

        -- CLONE
        ExtraAbilityButton = ability2:Clone()
        ExtraAbilityButton.Name = "Ability" .. index
        ExtraAbilityButton.Parent = abilitiesGui

        -- POSITIONING
        ExtraAbilityButton.Position = ability2.Position + UDim2.fromOffset(90, 0)

        -- PUSH EXISTING ABILITIES LEFT
        for _, name in ipairs({ "Ability1", "Ability2" }) do
            local ab = abilitiesGui:FindFirstChild(name)
            if ab then
                ab.Position = ab.Position - UDim2.fromOffset(90, 0)
            end
        end

        -- APPLY DATA
        ExtraAbilityButton.AbilityName.Text = data.Name
        ExtraAbilityButton.Icon.Image = data.Icon
        ExtraAbilityButton.Key.Text = ExtraAbilityKey

        updateExtraCooldownGui()
    end
})

---------------------------------------------------------------------
-- Keybind listener (manual fire)
---------------------------------------------------------------------
UserInputService.InputBegan:Connect(function(input, typing)
    if typing or not ExtraAbilityEnabled then return end
    if input.KeyCode.Name ~= ExtraAbilityKey then return end
    if not ExtraAbilityButton then return end

    local abilitiesGui = LocalPlayer.PlayerGui:FindFirstChild("Abilities")
    if not abilitiesGui then return end

    local remote =
        abilitiesGui:WaitForChild("KeyStuff")
        :WaitForChild("HandleAllat")

    remote:FireServer(
        ExtraAbilityButton.AbilityName.Text,
        ExtraAbilityButton
    )
end)

---------------------------------------------------------------------
-- Toggle for showing cooldown GUI
---------------------------------------------------------------------
AbilitiesTab:CreateToggle({
    Name = "Show Extra Ability Cooldowns",
    CurrentValue = false,
    Callback = function(Value)
        ShowExtraCooldowns = Value
        if Value then
            createExtraCooldownGui()
            task.spawn(function()
                while ShowExtraCooldowns do
                    updateExtraCooldownGui()
                    task.wait(1)
                end
            end)
        else
            if ExtraCooldownGui then
                ExtraCooldownGui:Destroy()
                ExtraCooldownGui = nil
            end
        end
    end
})

local Tab = Window:CreateTab("Anti & Buffs", 0) -- Title, Image

local Section = Tab:CreateSection("Anti Gui")

local antiTauntEnabled = false

Tab:CreateToggle({
    Name = "Anti Taunt",
    CurrentValue = false,
    Flag = "anti_taunt", -- config saving flag
    Callback = function(Value)
        antiTauntEnabled = Value

        if Value then
            task.spawn(function()
                while antiTauntEnabled do
                    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
                    if playerGui then
                        local tauntGui = playerGui:FindFirstChild("Taunt")
                        if tauntGui then
                            tauntGui:Destroy()
                        end
                    end
                    task.wait(0.11)
                end
            end)
        end
    end
})

local antiDiedEnabled = false

Tab:CreateToggle({
    Name = "Anti the annoying DeathScreen",
    CurrentValue = false,
    Flag = "anti_died",
    Callback = function(Value)
        antiDiedEnabled = Value

        if Value then
            task.spawn(function()
                while antiDiedEnabled do
                    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
                    if playerGui then
                        local diedGui = playerGui:FindFirstChild("Died")
                        if diedGui then
                            diedGui:Destroy()
                        end
                    end
                    task.wait(0.11)
                end
            end)
        end
    end
})

local antiScaryEnabled = false

Tab:CreateToggle({
    Name = "Anti Presence Screen",
    CurrentValue = false,
    Flag = "anti_scary",
    Callback = function(Value)
        antiScaryEnabled = Value

        if Value then
            task.spawn(function()
                while antiScaryEnabled do
                    local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
                    if playerGui then
                        local scaryGui = playerGui:FindFirstChild("Scary")
                        if scaryGui and scaryGui:IsA("ScreenGui") then
                            scaryGui:Destroy()
                        end
                    end
                    task.wait(0.11)
                end
            end)
        end
    end
})

local removeCinematicBarsEnabled = false

Tab:CreateToggle({
    Name = "Anti Cinematic Bars for Careless",
    CurrentValue = false,
    Flag = "remove_cinematic_bars",
    Callback = function(Value)
        removeCinematicBarsEnabled = Value

        if Value then
            task.spawn(function()
                while removeCinematicBarsEnabled do
                    local playerGui = game.Players.LocalPlayer:FindFirstChild("PlayerGui")
                    if playerGui then
                        local cinematicBars = playerGui:FindFirstChild("RealCinematicBars")
                        if cinematicBars then
                            cinematicBars:Destroy()
                        end
                    end
                    task.wait(0.11)
                end
            end)
        end
    end
})

local removeBlackButAutoEnabled = false

Tab:CreateToggle({
    Name = "Anti Black Screen for careless",
    CurrentValue = false,
    Flag = "remove_blackbutauto",
    Callback = function(Value)
        removeBlackButAutoEnabled = Value

        if Value then
            task.spawn(function()
                while removeBlackButAutoEnabled do
                    local playerGui = game.Players.LocalPlayer:FindFirstChild("PlayerGui")
                    if playerGui then
                        local targetGui = playerGui:FindFirstChild("BlackButAuto")
                        if targetGui then
                            targetGui:Destroy()
                        end
                    end
                    task.wait(0.1)
                end
            end)
        end
    end
})

local antiOmegaFlashEnabled = false

Tab:CreateToggle({
    Name = "anti Omega flash",
    CurrentValue = false,
    Flag = "anti_omega_flash",
    Callback = function(Value)
        antiOmegaFlashEnabled = Value

        if Value then
            task.spawn(function()
                while antiOmegaFlashEnabled do
                    local playerGui = game.Players.LocalPlayer:FindFirstChild("PlayerGui")
                    if playerGui then
                        local flashGui = playerGui:FindFirstChild("Flash")
                        if flashGui then
                            flashGui:Destroy()
                        end
                    end
                    task.wait(0.1)
                end
            end)
        end
    end
})

local Section = Tab:CreateSection("Anti Object")

local antiDoorsEnabled = false

Tab:CreateToggle({
    Name = "Anti Killer only doors",
    CurrentValue = false,
    Flag = "anti_killer_doors",
    Callback = function(Value)
        antiDoorsEnabled = Value

        if Value then
            task.spawn(function()
                while antiDoorsEnabled do
                    local mapFolder = workspace:FindFirstChild("Map")
                    if mapFolder then
                        -- Loop through all children in Map (the actual map folder is random)
                        for _, mapChild in pairs(mapFolder:GetChildren()) do
                            if mapChild:IsA("Folder") and mapChild.Name ~= "Map" then
                                local adminDoors = mapChild:FindFirstChild("AdminDoors")
                                if adminDoors then
                                    for _, door in pairs(adminDoors:GetChildren()) do
                                        if door.Name == "AdminDoor" then
                                            -- Set CanCollide to false for every AdminDoor
                                            pcall(function()
                                                door.CanCollide = false
                                            end)
                                        end
                                    end
                                end
                            end
                        end
                    end
                    task.wait(1) -- Adjust interval if needed
                end
            end)
        end
    end
})

local antiArtlessWallEnabled = false
local artlessCache = {}

Tab:CreateToggle({
    Name = "Anti Artless wall",
    CurrentValue = false,
    Flag = "anti_artless_wall",
    Callback = function(Value)
        antiArtlessWallEnabled = Value

        if Value then
            task.spawn(function()
                while antiArtlessWallEnabled do
                    local residue = workspace:FindFirstChild("Residue")
                    local artlessWall = residue and residue:FindFirstChild("ArtlessWall")

                    if artlessWall then
                        for _, obj in ipairs(artlessWall:GetDescendants()) do
                            if obj:IsA("BasePart") then
                                -- cache original values once
                                if not artlessCache[obj] then
                                    artlessCache[obj] = {
                                        CanCollide = obj.CanCollide,
                                        Transparency = obj.Transparency
                                    }
                                end

                                obj.CanCollide = false
                                obj.Transparency = math.clamp(obj.Transparency + 0.4, 0, 1)
                            end
                        end
                    end

                    task.wait(1)
                end
            end)
        else
            -- restore everything when toggled off
            for part, data in pairs(artlessCache) do
                if part and part.Parent then
                    part.CanCollide = data.CanCollide
                    part.Transparency = data.Transparency
                end
            end

            artlessCache = {}
        end
    end
})

---------------------------------------------------------------------
-- ===== BUFFS =====
---------------------------------------------------------------------

local Section = Tab:CreateSection("Buffs")

local ExtraSpeedEnabled = false
local ExtraSpeedValue = 0

-- Find character model under Teams
local function getTeamCharacter()
    local teams = workspace:FindFirstChild("Teams")
    if not teams then return nil end

    local playerName = game:GetService("Players").LocalPlayer.Name

    local civilians = teams:FindFirstChild("Civilians")
    if civilians and civilians:FindFirstChild(playerName) then
        return civilians[playerName]
    end

    local killers = teams:FindFirstChild("Killers")
    if killers and killers:FindFirstChild(playerName) then
        return killers[playerName]
    end

    return nil
end

-- Apply ExtraSpeed
local function applyExtraSpeed()
    local char = getTeamCharacter()
    if not char then return end

    local val = char:FindFirstChild("ExtraSpeed")
    if not val then
        val = Instance.new("NumberValue")
        val.Name = "ExtraSpeed"
        val.Parent = char
    end

    val.Value = ExtraSpeedValue
end

-- Remove ExtraSpeed
local function removeExtraSpeed()
    local char = getTeamCharacter()
    if not char then return end

    local val = char:FindFirstChild("ExtraSpeed")
    if val then
        val:Destroy()
    end
end

-- TextBox
Tab:CreateInput({
    Name = "ExtraSpeed Value",
    PlaceholderText = "Enter number (e.g. 10)",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        local num = tonumber(Text)
        if num then
            ExtraSpeedValue = num
            if ExtraSpeedEnabled then
                applyExtraSpeed()
            end
        end
    end
})

-- Toggle
Tab:CreateToggle({
    Name = "add ExtraSpeed",
    CurrentValue = false,
    Callback = function(Value)
        ExtraSpeedEnabled = Value
        if Value then
            applyExtraSpeed()
        else
            removeExtraSpeed()
        end
    end
})

local Tab = Window:CreateTab("Blackout Gamemode", 0) -- Title, Image

local aiESPEnabled = false
local aiHighlight
local aiConn

local function applyAIESP()
    local killers = workspace:FindFirstChild("Teams")
        and workspace.Teams:FindFirstChild("Killers")

    local model = killers and killers:FindFirstChild("GiveMeYourBest")

    if not model or not model:IsA("Model") then return end
    if aiHighlight then return end

    aiHighlight = Instance.new("Highlight")
    aiHighlight.Name = "GiveMeYourBestESP"
    aiHighlight.Adornee = model
    aiHighlight.FillColor = Color3.fromRGB(255, 0, 0)
    aiHighlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    aiHighlight.FillTransparency = 0.5
    aiHighlight.OutlineTransparency = 0
    aiHighlight.Parent = model
end

local function removeAIESP()
    if aiHighlight then
        aiHighlight:Destroy()
        aiHighlight = nil
    end
end

-- Listen for respawn / reinsert
local function hookAIListener()
    if aiConn then aiConn:Disconnect() end

    aiConn = workspace.DescendantAdded:Connect(function(obj)
        if not aiESPEnabled then return end
        if obj.Name == "GiveMeYourBest" and obj:IsA("Model") then
            task.wait()
            applyAIESP()
        end
    end)
end

-- Toggle
Tab:CreateToggle({
    Name = "ESP GiveMeYourBest",
    CurrentValue = false,
    Flag = "esp_givemeyourbest",
    Callback = function(Value)
        aiESPEnabled = Value

        if Value then
            applyAIESP()
            hookAIListener()
        else
            removeAIESP()
            if aiConn then
                aiConn:Disconnect()
                aiConn = nil
            end
        end
    end
})

-- ===== FULLBRIGHT =====

local fullbright = false
local saved = {}
local lightConn

local function saveLighting()
    saved = {
        Brightness = Lighting.Brightness,
        ClockTime = Lighting.ClockTime,
        Ambient = Lighting.Ambient,
        OutdoorAmbient = Lighting.OutdoorAmbient,
        GlobalShadows = Lighting.GlobalShadows
    }
end

local function applyFullbright()
    Lighting.Brightness = 2
    Lighting.ClockTime = 14
    Lighting.Ambient = Color3.new(1,1,1)
    Lighting.OutdoorAmbient = Color3.new(1,1,1)
    Lighting.GlobalShadows = false
end

local function restoreLighting()
    for k,v in pairs(saved) do Lighting[k] = v end
end

Tab:CreateToggle({
    Name = "FullBright",
    CurrentValue = false,
    Flag = "fullbright",
    Callback = function(Value)
        fullbright = Value
        if fullbright then
            saveLighting()
            applyFullbright()
            lightConn = Lighting.Changed:Connect(applyFullbright)
        else
            if lightConn then lightConn:Disconnect() end
            restoreLighting()
        end
    end
})

-- Teleport Tab
local Tab = Window:CreateTab("Teleports", 0) -- Title, Image

-- Go to the lobby
Tab:CreateButton({
    Name = "Go to the lobby",
    Callback = function()
        LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(
            -130.838303, 6.00004578, -1069.27356,
            0.999590337, 0, -0.028621342,
            0, 1, 0,
            0.028621342, 0, 0.999590337
        )
    end
})

-- Second teleport (platform / upper area)
Tab:CreateButton({
    Name = "go to test place",
    Callback = function()
        LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(
            -126, 42.000042, -1060,
            1, 1.21369925e-09, -8.98491893e-14,
            -1.21369925e-09, 1, -6.36375486e-09,
            8.98414643e-14, 6.36375486e-09, 1
        )
    end
})

-- Go to Civilian spawn (random "c" part)
Tab:CreateButton({
    Name = "Go to Civilian spawn",
    Callback = function()
        local mapFolder = workspace.Map:GetChildren()[1]
        local csFolder = mapFolder.cs
        local parts = csFolder:GetChildren()

        local randomPart = parts[math.random(1, #parts)]
        LocalPlayer.Character.HumanoidRootPart.CFrame = randomPart.CFrame
    end
})

local Tab = Window:CreateTab("Fun", 0) -- Title, Image

-- Toggle state
local resetSpamEnabled = false
local characterConnection

-- Your reset function (unchanged logic)
local function forceReset(speaker)
    local humanoid = speaker.Character and speaker.Character:FindFirstChildWhichIsA("Humanoid")

    if replicatesignal then
        replicatesignal(speaker.Kill)
    elseif humanoid then
        humanoid:ChangeState(Enum.HumanoidStateType.Dead)
    elseif speaker.Character then
        speaker.Character:BreakJoints()
    end
end

-- Rayfield Toggle
Tab:CreateToggle({
    Name = "Triple Reset On Respawn",
    CurrentValue = false,
    Callback = function(Value)
        resetSpamEnabled = Value

        -- Clean up old connection
        if characterConnection then
            characterConnection:Disconnect()
            characterConnection = nil
        end

        if resetSpamEnabled then
            characterConnection = player.CharacterAdded:Connect(function()
                -- tiny delay to ensure character exists
                task.wait()

                for i = 1, 3 do
                    forceReset(player)
                end
            end)
        end
    end
})

local Tab = Window:CreateTab("Misc", 0) -- Title, Image

local Button = Tab:CreateButton({
   Name = "Infinite yield",
   Callback = function()
   loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))()-- The function that takes place when the button is pressed
   end,
})

local Button = Tab:CreateButton({
   Name = "Dex Explorer",
   Callback = function()
   loadstring(game:HttpGet("https://raw.githubusercontent.com/infyiff/backup/main/dex.lua"))()-- The function that takes place when the button is pressed
   end,
})

local StatsGui
local RenderConn

Tab:CreateToggle({
    Name = "FPS and Ping stats",
    CurrentValue = false,
    Callback = function(Value)
        if Value then
            -- prevent duplicates
            if StatsGui then return end

            StatsGui = Instance.new("ScreenGui")
            StatsGui.Name = "StatsGui"
            StatsGui.ResetOnSpawn = false
            StatsGui.Parent = game.CoreGui

            local text = Instance.new("TextLabel")
            text.Size = UDim2.new(0, 300, 0, 90)
            text.Position = UDim2.new(0, 10, 1, -100)
            text.BackgroundTransparency = 1
            text.TextXAlignment = Enum.TextXAlignment.Left
            text.TextYAlignment = Enum.TextYAlignment.Top
            text.Font = Enum.Font.SourceSansBold
            text.TextSize = 22 -- BIGGER TEXT
            text.TextColor3 = Color3.fromRGB(255, 255, 255)
            text.TextStrokeTransparency = 0
            text.Text = "Loading..."
            text.Parent = StatsGui

            -- FPS (fast & stable)
            local fps = 0
            local frames = 0
            local last = os.clock()

            RenderConn = RunService.RenderStepped:Connect(function()
                if not StatsGui then return end

                -- FPS
                frames += 1
                local now = os.clock()
                if now - last >= 0.5 then -- updates faster
                    fps = math.floor(frames / (now - last))
                    frames = 0
                    last = now
                end

                -- Ping (fast)
                local ping = math.floor(
                    Stats.Network.ServerStatsItem["Data Ping"]:GetValue()
                )

                -- FULL Hint text (no parsing)
                local hintText = "Waiting..."
                local hint = workspace:FindFirstChild("Hint")
                if hint and hint:FindFirstChild("Appearance") then
                    hintText = hint.Appearance.Text
                end

                text.Text =
                    "FPS: " .. fps ..
                    "\nPing: " .. ping .. " ms" ..
                    "\n" .. hintText
            end)

        else
            -- toggle OFF cleanup
            if RenderConn then
                RenderConn:Disconnect()
                RenderConn = nil
            end

            if StatsGui then
                StatsGui:Destroy()
                StatsGui = nil
            end
        end
    end
})
